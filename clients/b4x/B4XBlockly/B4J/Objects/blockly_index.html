<!DOCTYPE html>
<html>
<!-- 
	Project:	HomeKit32
	File:		blockly_index.html.
	Brief:		Blockly example for the HomeKit32 (HK32) project.
	Date:		20251211
	Author:		Robert W.B. Linn (c) 2025 MIT
	
	Notes:		Stay with 12.3.1 UMD build, 100% compatible, stable, fastest solution.
				Blockly must be initialized in the right order:
				1) Define custom blocks   (Blockly.Blocks['...'])
				2) Define custom generators (runtimeGenerators)
				3) Prepare toolboxJson
				4) Inject Blockly
				5) Register runtime generators (tie workspace + blocks)
				6) Patch runner / disable features / hide UI buttons

-->

<head>
	<meta charset="utf-8">
	<title>Blockly HomeKit32</title>

	<!-- Core Blockly v12 = Load main Blockly library first -->
	<script src="https://unpkg.com/blockly@12.3.1/blockly.min.js"></script>

	<!-- Load the JavaScript generator after Blockly -->
	<script src="https://unpkg.com/blockly@12.3.1/javascript_compressed"></script>

	<style>
	  html, body { height: 100%; margin: 0; }
	  #blocklyDiv { height: calc(100% - 40px); width: 100%; }
	  #buttons { height: 40px; padding: 6px; background: #f4f4f4; box-sizing: border-box; }
	  button { margin-right: 6px; }
	</style>
</head>

<body>

<!-- HTML control buttons (B4J will usually trigger these) -->
<div id="buttons">
	<button id="btnRun">Run</button>
	<!-- B4J can call runWorkspaceBlocks() directly, see blockly_app.js -->
	<button id="btnClear">Clear</button>
</div>

<!-- Blockly will be injected here -->
<div id="blocklyDiv"></div>

<!-- 
	Toolbox: categories / blocks shown in the sidebar 
-->

<!-- Define the getElementById interception before loading Blockly scripts -->
<script>
	const originalGetElementById = document.getElementById;
	document.getElementById = function(id) {
		if (!id) {
			console.error('getElementById called with an empty or invalid ID');
		}
		return originalGetElementById.apply(this, arguments);
	};
</script>


<script>
/*
	Notes:
	-toolboxJson only defines the categories and the blocks.
	-the blocks as such are defined in blockly_standard_blocks.js and blockly_custom_blocks.js.
	-ensure to add generators for the blocks in blockly_generators.js.
	-if testing in browser and want to create variables then add JSON:
		{"kind": "category","name": "Variables","custom": "VARIABLE","colour": "330"}
		{"kind": "category","name": "Variables","colour": "330","contents": [{"kind": "block","type": "variables_get"},{"kind": "block","type": "variables_set"}]}
	-if testing in browser use console.log
	-DO NOT USE Blockly.inject('blocklyDiv' ... because done in blockly_app.js > window.onload
	-Tips for B4J WebView / Runtime Integration
		-Every block needs a runtime generator if it produces a value or triggers commands.
		-For value blocks, define output in JSON and use evalInputAsync in the generator.
		-For statement blocks, define previousStatement / nextStatement and use runBlockQueue in generator.
		-Only include “Create Variable” in browser testing; hide in B4J WebView to avoid WebView issues.
*/
const toolboxJson = {
  "kind": "categoryToolbox",
  "contents": [
    {
      "kind": "category",
      "name": "HomeKit32",
      "colour": "120",
      "contents": [
        { "kind": "block", "type": "connect" },
        { "kind": "block", "type": "disconnect" },
        { "kind": "block", "type": "yellow_led_on" },
        { "kind": "block", "type": "yellow_led_off" },
        { "kind": "block", "type": "yellow_led" },
        { "kind": "block", "type": "delay" },
        { "kind": "block", "type": "dht11_sensor" },
        { "kind": "block", "type": "door_open" },
        { "kind": "block", "type": "door_close" },
      ]
    },

    {
      "kind": "category",
      "name": "Program Flow",
      "colour": "0",
      "contents": [
        { "kind": "block", "type": "start_block" },
        { "kind": "block", "type": "stop_block" },
        { "kind": "block", "type": "comment_block" },
		{ "kind": "block", "type": "log_block"},
        { "kind": "block", "type": "text_literal" }
      ]
    },

    {
      "kind": "category",
      "name": "Loops",
      "colour": "120",
      "contents": [
        {
          "kind": "block",
          "type": "repeat_loop",
          "inputs": {
            "TIMES": {
              "shadow": {
                "type": "math_number",
                "fields": { "NUM": 5 }
              }
            }
          }
        },
        { "kind": "block", "type": "while_loop" },
		{ "kind": "block", "type": "for_to_step_loop" }
      ]
    },

    {
      "kind": "category",
      "name": "Logic",
      "colour": "210",
      "contents": [
        { "kind": "block", "type": "logic_boolean" },
        { "kind": "block", "type": "logic_compare" },
        { "kind": "block", "type": "logic_operation" },
        { "kind": "block", "type": "logic_negate" },
        { "kind": "block", "type": "logic_if" },
        { "kind": "block", "type": "logic_if_else" },
        { "kind": "block", "type": "logic_else_if" }
      ]
    },

    {
      "kind": "category",
      "name": "Math",
      "colour": "230",
      "contents": [
        {
          "kind": "block",
          "type": "math_number",
		  "fields": { "NUM": 0 }
        },
		{
		  "kind": "block",
		  "type": "math_arithmetic",
		  "fields": { 
			"OP": "ADD" 
		  },
		  "inputs": {
			"A": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			},
			"B": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			}
		  }
		},
		{
		  "kind": "block",
		  "type": "math_arithmetic",
		  "fields": { 
			"OP": "MINUS" 
		  },
		  "inputs": {
			"A": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			},
			"B": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			}
		  }
		},
		{
		  "kind": "block",
		  "type": "math_arithmetic",
		  "fields": { 
			"OP": "MULTIPLY" 
		  },
		  "inputs": {
			"A": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			},
			"B": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			}
		  }
		},
		{
		  "kind": "block",
		  "type": "math_arithmetic",
		  "fields": { 
			"OP": "DIVIDE" 
		  },
		  "inputs": {
			"A": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			},
			"B": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			}
		  }
		},
		{
		  "kind": "block",
		  "type": "math_arithmetic",
		  "fields": { 
			"OP": "POWER" 
		  },
		  "inputs": {
			"A": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			},
			"B": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			}
		  }
		},
		{
		  "kind": "block",
		  "type": "math_random_int",
		  "inputs": {
			"FROM": { "shadow": { "type": "math_number", "fields": { "NUM": 1 } } },
			"TO": { "shadow": { "type": "math_number", "fields": { "NUM": 10 } } }
		  }
		},
        {
          "kind": "block",
          "type": "math_random_float"
        },
        {
          "kind": "block",
          "type": "math_round",
          "fields": {
            "OP": "ROUND"
          }
        },
		{
		  "kind": "block",
		  "type": "math_modulo",
		  "inputs": {
			"DIVIDEND": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 0 }
			  }
			},
			"DIVISOR": {
			  "shadow": {
				"type": "math_number",
				"fields": { "NUM": 1 }
			  }
			}
		  }
		}
      ]
    },

	{
	  "kind": "category",
	  "name": "Variables",
	  "colour": "330",
	  "contents": [
		{
		  "kind": "block",
		  "type": "variables_get"
		},
		{
		  "kind": "block",
		  "type": "variables_set"
		},
		{
			"kind": "block",
			"type": "show_variable"
		}
	  ]
	}

	// Add more
  ]
};

/* DO NOT USE because done in blockly_app > window.onload
const workspace = Blockly.inject('blocklyDiv', {
  toolbox: toolboxJson,
  renderer: 'geras',        // or "zelos", "thrasos"
  theme: Blockly.Themes.Classic,
  trashcan: true,
});
*/

</script>

<!-- New variable dialog (used to create variables in the web UI) -->
<div id="variableDialog" style="
    display:none;
    position:absolute;
    top:50%;
    left:50%;
    transform: translate(-50%, -50%);
    background:white;
    border: 2px solid #444;
    padding: 20px;
    z-index:1000;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
">
    <label for="varNameInput">Variable name:</label>
    <input id="varNameInput" type="text" />
    <button id="btnVarOK">OK</button>
    <button id="btnVarCancel">Cancel</button>
</div>

<!-- Keep single blocklyDiv (already present above) -->

<!-- 
	LOAD JS AFTER HTML, IMPORTANT! 
	(order matters: block definitions, standard defs, generators, device states, app)
-->
<script src="blockly_custom_blocks.js"></script>
<script src="blockly_standard_blocks.js"></script>
<script src="blockly_generators.js"></script>
<script src="blockly_device_states.js"></script>
<script src="blockly_app.js"></script>

</body>
</html>
